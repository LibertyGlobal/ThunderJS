<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
/*
 * If not stated otherwise in this file or this component's LICENSE file the
 * following copyright and licenses apply:
 *
 * Copyright 2020 RDK Management
 *
 * Licensed under the Apache License, Version 2.0 (the License);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var WebSocket=_interopDefault(require("isomorphic-ws"));function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function ownKeys(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),n.push.apply(n,r)}return n}function _objectSpread2(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(Object(n),!0).forEach(function(e){_defineProperty(t,e,n[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):ownKeys(Object(n)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))})}return t}var requestsQueue={},listeners={},requestQueueResolver=function(e){if("string"==typeof e&&(e=JSON.parse(e.normalize().replace(/\\x([0-9A-Fa-f]{2})/g,""))),e.id){var t=requestsQueue[e.id];t?("result"in e?t.resolve(e.result):t.reject(e.error),delete requestsQueue[e.id]):console.log("no pending request found with id "+e.id)}},notificationListener=function(t){if("string"==typeof t&&(t=JSON.parse(t.normalize().replace(/\\x([0-9A-Fa-f]{2})/g,""))),!t.id&&t.method){var e=listeners[t.method];e&&Array.isArray(e)&&e.length?e.forEach(function(e){e(t.params)}):console.log("no callbacks for "+t.method)}},protocol="ws://",host="localhost",endpoint="/jsonrpc",port=80,makeWebsocketAddress=function(e){return[e&&e.protocol||protocol,e&&e.host||host,":"+(e&&e.port||port),e&&e.endpoint||endpoint,e&&e.token?"?token="+e.token:null].join("")},protocols="notification",connection=null,socket=null,connect=function(n){return new Promise(function(e,t){if(connection)e(connection);else try{socket||((socket=new WebSocket(makeWebsocketAddress(n),protocols)).addEventListener("message",function(e){requestQueueResolver(e.data)}),socket.addEventListener("message",function(e){notificationListener(e.data)})),socket.addEventListener("open",function(){e(connection=socket)})}catch(e){t(e)}})},makeBody=function(e,t,n,r,o){r&&delete r.version;var i={jsonrpc:"2.0",id:e,method:[t,o,n].join(".")};return!r&&!1!==r||"object"===_typeof(r)&&0===Object.keys(r).length||(i.params=r),i},getVersion=function(e,t,n){var r;return(r=n&&n.version)?r:e&&(e[t]||e.default)||1},id=0,makeId=function(){return id+=1},execRequest=function(e,t){connect(e).then(function(e){e.send(JSON.stringify(t))}).catch(console.error)},API=function(u){return{request:function(i,s,c){return new Promise(function(e,t){var n=makeId(),r=getVersion(u.versions,i,c),o=makeBody(n,i,s,c,r);u.debug&&(console.log(" "),console.log("API REQUEST:"),console.log(JSON.stringify(o,null,2)),console.log(" ")),requestsQueue[n]={body:o,resolve:e,reject:t},execRequest(u,o)})}}},DeviceInfo={freeRam:function(e){return this.call("systeminfo",e).then(function(e){return e.freeram})},version:function(e){return this.call("systeminfo",e).then(function(e){return e.version})}},plugins={DeviceInfo:DeviceInfo};function listener(t,n,e){var r=this,o=register.call(this,t,n,e);return{dispose:function(){var e=makeListenerId(t,n);listeners[e].splice(o,1),0===listeners[e].length&&unregister.call(r,t,n)}}}var api,makeListenerId=function(e,t){return["client",e,"events",t].join(".")},register=function(e,t,n){var r=makeListenerId(e,t);if(!listeners[r]){listeners[r]=[];var o={event:t,id:r.split(".").slice(0,-1).join(".")};this.api.request(e,"register",o).then().catch()}return listeners[r].push(n),listeners[r].length-1},unregister=function(e,t){var n=makeListenerId(e,t);delete listeners[n];var r={event:t,id:n.split(".").slice(0,-1).join(".")};this.api.request(e,"unregister",r)},thunderJS=function(e){return globalThis.thunder&&"function"==typeof globalThis.thunder.token&&(e.token=globalThis.thunder.token()),api=API(e),wrapper(_objectSpread2({},thunder(e),{},plugins))},resolve=function(n,e){"object"===_typeof(n)&&("object"!==_typeof(n)||n.then&&"function"==typeof n.then)||(n=new Promise(function(e,t){(n instanceof Error==!1?e:t)(n)}));var t="function"==typeof e[e.length-1]?e[e.length-1]:null;if(!t)return n;n.then(function(e){return t(null,e)}).catch(function(e){return t(e)})},thunder=function n(e){return{options:e,plugin:!1,call:function(){var e=Array.prototype.slice.call(arguments);this.plugin&&e[0]!==this.plugin&&e.unshift(this.plugin);var t=e[0],n=e[1];return"function"==typeof this[t][n]?this[t][n](e[2]):this.api.request.apply(this,e)},registerPlugin:function(e,t){this[e]=wrapper(Object.assign(Object.create(n),t,{plugin:e}))},subscribe:function(){},on:function(){var e=Array.prototype.slice.call(arguments);return this.plugin&&e[0]!==this.plugin&&e.unshift(this.plugin),listener.apply(this,e)},once:function(){console.log("todo ...")}}},wrapper=function e(t){return new Proxy(t,{get:function(r,o){var i=r[o];return"api"===o?api:void 0!==i?"function"==typeof i?-1<["on","once","subscribe"].indexOf(o)?function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return i.apply(this,t)}:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return resolve(i.apply(this,t),t)}:"object"===_typeof(i)?e(Object.assign(Object.create(thunder(r.options)),i,{plugin:o})):i:!1===r.plugin?e(Object.assign(Object.create(thunder(r.options)),{},{plugin:o})):function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return t.unshift(o),r.call.apply(this,t)}}})};module.exports=thunderJS;
=======
"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var WebSocket=_interopDefault(require("isomorphic-ws"));function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function ownKeys(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),n.push.apply(n,r)}return n}function _objectSpread2(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(n,!0).forEach(function(e){_defineProperty(t,e,n[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):ownKeys(n).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))})}return t}var requestsQueue={},listeners={},requestQueueResolver=function(e){if("string"==typeof e)try{e=JSON.parse(e.normalize())}catch(e){}if(e.id){var t=requestsQueue[e.id];t?("result"in e?t.resolve(e.result):t.reject(e.error),delete requestsQueue[e.id]):console.log("no pending request found with id "+e.id)}},notificationListener=function(t){if("string"==typeof t)try{t=JSON.parse(t.normalize())}catch(e){}if(!t.id&&t.method){var e=listeners[t.method];e&&Array.isArray(e)&&e.length&&e.forEach(function(e){e(t.params)})}},protocol="ws://",host="localhost",endpoint="/jsonrpc",port=80,makeWebsocketAddress=function(e){return[e&&e.protocol||protocol,e&&e.host||host,":"+(e&&e.port||port),e&&e.endpoint||endpoint].join("")},protocols="notification",connection=null,socket=null,connect=function(n){return new Promise(function(e,t){if(connection)e(connection);else try{socket||((socket=new WebSocket(makeWebsocketAddress(n),protocols)).addEventListener("message",function(e){requestQueueResolver(e.data)}),socket.addEventListener("message",function(e){notificationListener(e.data)})),socket.addEventListener("open",function(){notificationListener({method:"client.ThunderJS.events.connect"}),e(connection=socket)}),socket.addEventListener("close",function(){notificationListener({method:"client.ThunderJS.events.disconnect"}),connection=socket=null})}catch(e){t(e)}})},makeBody=function(e,t,n,r,o){r&&delete r.version;var i={jsonrpc:"2.0",id:e,method:[t,o,n].join(".")};return!r&&!1!==r||"object"===_typeof(r)&&0===Object.keys(r).length||(i.params=r),i},getVersion=function(e,t,n){var r;return(r=n&&n.version)?r:e&&(e[t]||e.default)||1},id=0,makeId=function(){return id+=1},execRequest=function(e,t){connect(e).then(function(e){e.send(JSON.stringify(t))}).catch(console.error)},API=function(u){return{request:function(i,s,c){return new Promise(function(e,t){var n=makeId(),r=getVersion(u.versions,i,c),o=makeBody(n,i,s,c,r);u.debug&&(console.log(" "),console.log("API REQUEST:"),console.log(JSON.stringify(o,null,2)),console.log(" ")),requestsQueue[n]={body:o,resolve:e,reject:t},execRequest(u,o)})}}},DeviceInfo={freeRam:function(e){return this.call("systeminfo",e).then(function(e){return e.freeram})},version:function(e){return this.call("systeminfo",e).then(function(e){return e.version})}},plugins={DeviceInfo:DeviceInfo};function listener(t,n,e){var r=this,o=register.call(this,t,n,e);return{dispose:function(){var e=makeListenerId(t,n);listeners[e].splice(o,1),0===listeners[e].length&&unregister.call(r,t,n)}}}var api,makeListenerId=function(e,t){return["client",e,"events",t].join(".")},register=function(e,t,n){var r=makeListenerId(e,t);if(!listeners[r]&&(listeners[r]=[],"ThunderJS"!==e)){var o={event:t,id:r.split(".").slice(0,-1).join(".")};this.api.request(e,"register",o).then().catch()}return listeners[r].push(n),listeners[r].length-1},unregister=function(e,t){var n=makeListenerId(e,t);if(delete listeners[n],"ThunderJS"!==e){var r={event:t,id:n.split(".").slice(0,-1).join(".")};this.api.request(e,"unregister",r)}},thunderJS=function(e){return api=API(e),wrapper(_objectSpread2({},thunder(e),{},plugins))},resolve=function(n,e){"object"===_typeof(n)&&("object"!==_typeof(n)||n.then&&"function"==typeof n.then)||(n=new Promise(function(e,t){n instanceof Error==!1?e(n):t(n)}));var t="function"==typeof e[e.length-1]?e[e.length-1]:null;if(!t)return n;n.then(function(e){return t(null,e)}).catch(function(e){return t(e)})},thunder=function n(e){return{options:e,plugin:!1,call:function(){var e=Array.prototype.slice.call(arguments);this.plugin&&e[0]!==this.plugin&&e.unshift(this.plugin);var t=e[0],n=e[1];return"function"==typeof this[t][n]?this[t][n](e[2]):this.api.request.apply(this,e)},registerPlugin:function(e,t){this[e]=wrapper(Object.assign(Object.create(n),t,{plugin:e}))},subscribe:function(){},on:function(){var e=Array.prototype.slice.call(arguments);return-1<e[0].indexOf("connect","disconnect")?e.unshift("ThunderJS"):this.plugin&&e[0]!==this.plugin&&e.unshift(this.plugin),listener.apply(this,e)},once:function(){console.log("todo ...")}}},wrapper=function e(t){return new Proxy(t,{get:function(r,o){var i=r[o];return"api"===o?api:void 0!==i?"function"==typeof i?-1<["on","once","subscribe"].indexOf(o)?function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return i.apply(this,t)}:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return resolve(i.apply(this,t),t)}:"object"===_typeof(i)?e(Object.assign(Object.create(thunder(r.options)),i,{plugin:o})):i:!1===r.plugin?e(Object.assign(Object.create(thunder(r.options)),{},{plugin:o})):function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return t.unshift(o),r.call.apply(this,t)}}})};module.exports=thunderJS;
>>>>>>> Added connect and disconnect events.
=======
"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var WebSocket=_interopDefault(require("isomorphic-ws"));function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _defineProperty(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function ownKeys(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(n);e&&(o=o.filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})),t.push.apply(t,o)}return t}function _objectSpread2(n){for(var e=1;e<arguments.length;e++){var t=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(Object(t),!0).forEach(function(e){_defineProperty(n,e,t[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(t)):ownKeys(Object(t)).forEach(function(e){Object.defineProperty(n,e,Object.getOwnPropertyDescriptor(t,e))})}return n}var requestsQueue={},listeners={},requestQueueResolver=function(e){if("string"==typeof e)try{e=JSON.parse(e.normalize())}catch(e){}if(e.id){var n=requestsQueue[e.id];n?("result"in e?n.resolve(e.result):n.reject(e.error),delete requestsQueue[e.id]):console.log("no pending request found with id "+e.id)}},notificationListener=function(n){if("string"==typeof n)try{n=JSON.parse(n.normalize())}catch(e){}if(!n.id&&n.method){var e=listeners[n.method];e&&Array.isArray(e)&&e.length&&e.forEach(function(e){e(n.params)})}},protocol="ws://",host="localhost",endpoint="/jsonrpc",port=80,makeWebsocketAddress=function(e){return[e&&e.protocol||protocol,e&&e.host||host,":"+(e&&e.port||port),e&&e.endpoint||endpoint].join("")},protocols="notification",connection=null,socket=null,connect=function(t){return new Promise(function(e,n){if(connection)e(connection);else try{socket||((socket=new WebSocket(makeWebsocketAddress(t),protocols)).addEventListener("message",function(e){requestQueueResolver(e.data)}),socket.addEventListener("message",function(e){notificationListener(e.data)})),socket.addEventListener("open",function(){notificationListener({method:"client.ThunderJS.events.connect"}),e(connection=socket)}),socket.addEventListener("error",function(e){notificationListener({method:"client.ThunderJS.events.error"}),connection=socket=null,n(e)}),socket.addEventListener("close",function(e){socket&&(notificationListener({method:"client.ThunderJS.events.disconnect"}),connection=socket=null,n(e))})}catch(e){n(e)}})},makeBody=function(e,n,t,o,r){o&&delete o.version;var i={jsonrpc:"2.0",id:e,method:[n,r,t].join(".")};return!o&&!1!==o||"object"===_typeof(o)&&0===Object.keys(o).length||(i.params=o),i},getVersion=function(e,n,t){var o;return(o=t&&t.version)?o:e&&(e[n]||e.default)||1},id=0,makeId=function(){return id+=1},execRequest=function(n,t){connect(n).then(function(e){e.send(JSON.stringify(t))}).catch(function(e){n.debug&&(console.log(" "),console.log("API ERROR:"),console.log(JSON.stringify(n,null,2)),console.log(" "),console.log("ERROR: "),console.log(JSON.stringify(e,null,2)),console.log(" "))})},API=function(u){return{request:function(i,s,c){return new Promise(function(e,n){var t=makeId(),o=getVersion(u.versions,i,c),r=makeBody(t,i,s,c,o);u.debug&&(console.log(" "),console.log("API REQUEST:"),console.log(JSON.stringify(r,null,2)),console.log(" ")),requestsQueue[t]={body:r,resolve:e,reject:n},execRequest(u,r)})}}},DeviceInfo={freeRam:function(e){return this.call("systeminfo",e).then(function(e){return e.freeram})},version:function(e){return this.call("systeminfo",e).then(function(e){return e.version})}},plugins={DeviceInfo:DeviceInfo};function listener(n,t,e){var o=this,r=register.call(this,n,t,e);return{dispose:function(){var e=makeListenerId(n,t);listeners[e].splice(r,1),0===listeners[e].length&&unregister.call(o,n,t)}}}var api,makeListenerId=function(e,n){return["client",e,"events",n].join(".")},register=function(e,n,t){var o=makeListenerId(e,n);if(!listeners[o]&&(listeners[o]=[],"ThunderJS"!==e)){var r={event:n,id:o.split(".").slice(0,-1).join(".")};this.api.request(e,"register",r)}return listeners[o].push(t),listeners[o].length-1},unregister=function(e,n){var t=makeListenerId(e,n);if(delete listeners[t],"ThunderJS"!==e){var o={event:n,id:t.split(".").slice(0,-1).join(".")};this.api.request(e,"unregister",o)}},thunderJS=function(e){return api=API(e),wrapper(_objectSpread2({},thunder(e),{},plugins))},resolve=function(t,e){"object"===_typeof(t)&&("object"!==_typeof(t)||t.then&&"function"==typeof t.then)||(t=new Promise(function(e,n){(t instanceof Error==!1?e:n)(t)}));var n="function"==typeof e[e.length-1]?e[e.length-1]:null;if(!n)return t;t.then(function(e){return n(null,e)}).catch(function(e){return n(e)})},thunder=function t(e){return{options:e,plugin:!1,call:function(){var e=Array.prototype.slice.call(arguments);this.plugin&&e[0]!==this.plugin&&e.unshift(this.plugin);var n=e[0],t=e[1];return"function"==typeof this[n][t]?this[n][t](e[2]):this.api.request.apply(this,e)},registerPlugin:function(e,n){this[e]=wrapper(Object.assign(Object.create(t),n,{plugin:e}))},subscribe:function(){},on:function(){var e=Array.prototype.slice.call(arguments);return-1!==["connect","disconnect","error"].indexOf(e[0])?e.unshift("ThunderJS"):this.plugin&&e[0]!==this.plugin&&e.unshift(this.plugin),listener.apply(this,e)},once:function(){console.log("todo ...")}}},wrapper=function e(n){return new Proxy(n,{get:function(o,r){var i=o[r];return"api"===r?api:void 0!==i?"function"==typeof i?-1<["on","once","subscribe"].indexOf(r)?function(){for(var e=arguments.length,n=new Array(e),t=0;t<e;t++)n[t]=arguments[t];return i.apply(this,n)}:function(){for(var e=arguments.length,n=new Array(e),t=0;t<e;t++)n[t]=arguments[t];return resolve(i.apply(this,n),n)}:"object"===_typeof(i)?e(Object.assign(Object.create(thunder(o.options)),i,{plugin:r})):i:!1===o.plugin?e(Object.assign(Object.create(thunder(o.options)),{},{plugin:r})):function(){for(var e=arguments.length,n=new Array(e),t=0;t<e;t++)n[t]=arguments[t];return n.unshift(r),o.call.apply(this,n)}}})};module.exports=thunderJS;
>>>>>>> Add error handling, reject requests on error/close
=======
"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var WebSocket=_interopDefault(require("isomorphic-ws"));function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _defineProperty(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function ownKeys(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(n);e&&(o=o.filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})),t.push.apply(t,o)}return t}function _objectSpread2(n){for(var e=1;e<arguments.length;e++){var t=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(t,!0).forEach(function(e){_defineProperty(n,e,t[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(t)):ownKeys(t).forEach(function(e){Object.defineProperty(n,e,Object.getOwnPropertyDescriptor(t,e))})}return n}var requestsQueue={},listeners={},requestQueueResolver=function(e){if("string"==typeof e)try{e=JSON.parse(e.normalize())}catch(e){}if(e.id){var n=requestsQueue[e.id];n?("result"in e?n.resolve(e.result):n.reject(e.error),delete requestsQueue[e.id]):console.log("no pending request found with id "+e.id)}},notificationListener=function(n){if("string"==typeof n)try{n=JSON.parse(n.normalize())}catch(e){}if(!n.id&&n.method){var e=listeners[n.method];e&&Array.isArray(e)&&e.length&&e.forEach(function(e){e(n.params)})}},protocol="ws://",host="localhost",endpoint="/jsonrpc",port=80,makeWebsocketAddress=function(e){return[e&&e.protocol||protocol,e&&e.host||host,":"+(e&&e.port||port),e&&e.endpoint||endpoint].join("")},protocols="notification",connection=null,socket=null,connect=function(t){return new Promise(function(e,n){if(connection)e(connection);else try{socket||((socket=new WebSocket(makeWebsocketAddress(t),protocols)).addEventListener("message",function(e){requestQueueResolver(e.data)}),socket.addEventListener("message",function(e){notificationListener(e.data)})),socket.addEventListener("open",function(){notificationListener({method:"client.ThunderJS.events.connect"}),e(connection=socket)}),socket.addEventListener("error",function(e){notificationListener({method:"client.ThunderJS.events.error"}),connection=socket=null,n(e)}),socket.addEventListener("close",function(e){socket&&(notificationListener({method:"client.ThunderJS.events.disconnect"}),connection=socket=null,n(e))})}catch(e){n(e)}})},makeBody=function(e,n,t,o,r){o&&delete o.version;var i={jsonrpc:"2.0",id:e,method:[n,r,t].join(".")};return!o&&!1!==o||"object"===_typeof(o)&&0===Object.keys(o).length||(i.params=o),i},getVersion=function(e,n,t){var o;return(o=t&&t.version)?o:e&&(e[n]||e.default)||1},id=0,makeId=function(){return id+=1},execRequest=function(n,t){connect(n).then(function(e){e.send(JSON.stringify(t))}).catch(function(e){n.debug&&(console.log(" "),console.log("API ERROR:"),console.log(JSON.stringify(n,null,2)),console.log(" "),console.log("ERROR: "),console.log(JSON.stringify(e,null,2)),console.log(" "))})},API=function(u){return{request:function(i,s,c){return new Promise(function(e,n){var t=makeId(),o=getVersion(u.versions,i,c),r=makeBody(t,i,s,c,o);u.debug&&(console.log(" "),console.log("API REQUEST:"),console.log(JSON.stringify(r,null,2)),console.log(" ")),requestsQueue[t]={body:r,resolve:e,reject:n},execRequest(u,r)})}}},DeviceInfo={freeRam:function(e){return this.call("systeminfo",e).then(function(e){return e.freeram})},version:function(e){return this.call("systeminfo",e).then(function(e){return e.version})}},plugins={DeviceInfo:DeviceInfo};function listener(n,t,e){var o=this,r=register.call(this,n,t,e);return{dispose:function(){var e=makeListenerId(n,t);listeners[e].splice(r,1),0===listeners[e].length&&unregister.call(o,n,t)}}}var api,makeListenerId=function(e,n){return["client",e,"events",n].join(".")},register=function(e,n,t){var o=makeListenerId(e,n);if(!listeners[o]&&(listeners[o]=[],"ThunderJS"!==e)){var r={event:n,id:o.split(".").slice(0,-1).join(".")};this.api.request(e,"register",r)}return listeners[o].push(t),listeners[o].length-1},unregister=function(e,n){var t=makeListenerId(e,n);if(delete listeners[t],"ThunderJS"!==e){var o={event:n,id:t.split(".").slice(0,-1).join(".")};this.api.request(e,"unregister",o)}},thunderJS=function(e){return api=API(e),wrapper(_objectSpread2({},thunder(e),{},plugins))},resolve=function(t,e){"object"===_typeof(t)&&("object"!==_typeof(t)||t.then&&"function"==typeof t.then)||(t=new Promise(function(e,n){t instanceof Error==!1?e(t):n(t)}));var n="function"==typeof e[e.length-1]?e[e.length-1]:null;if(!n)return t;t.then(function(e){return n(null,e)}).catch(function(e){return n(e)})},thunder=function t(e){return{options:e,plugin:!1,call:function(){var e=Array.prototype.slice.call(arguments);this.plugin&&e[0]!==this.plugin&&e.unshift(this.plugin);var n=e[0],t=e[1];return"function"==typeof this[n][t]?this[n][t](e[2]):this.api.request.apply(this,e)},registerPlugin:function(e,n){this[e]=wrapper(Object.assign(Object.create(t),n,{plugin:e}))},subscribe:function(){},on:function(){var e=Array.prototype.slice.call(arguments);return-1!==["connect","disconnect","error"].indexOf(e[0])?e.unshift("ThunderJS"):this.plugin&&e[0]!==this.plugin&&e.unshift(this.plugin),listener.apply(this,e)},once:function(){console.log("todo ...")}}},wrapper=function e(n){return new Proxy(n,{get:function(o,r){var i=o[r];return"api"===r?api:void 0!==i?"function"==typeof i?-1<["on","once","subscribe"].indexOf(r)?function(){for(var e=arguments.length,n=new Array(e),t=0;t<e;t++)n[t]=arguments[t];return i.apply(this,n)}:function(){for(var e=arguments.length,n=new Array(e),t=0;t<e;t++)n[t]=arguments[t];return resolve(i.apply(this,n),n)}:"object"===_typeof(i)?e(Object.assign(Object.create(thunder(o.options)),i,{plugin:r})):i:!1===o.plugin?e(Object.assign(Object.create(thunder(o.options)),{},{plugin:r})):function(){for(var e=arguments.length,n=new Array(e),t=0;t<e;t++)n[t]=arguments[t];return n.unshift(r),o.call.apply(this,n)}}})};module.exports=thunderJS;
>>>>>>> Fixed disconnect WS test.
=======
"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var WebSocket=_interopDefault(require("isomorphic-ws"));function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function ownKeys(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(t);e&&(o=o.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),n.push.apply(n,o)}return n}function _objectSpread2(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(Object(n),!0).forEach(function(e){_defineProperty(t,e,n[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):ownKeys(Object(n)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))})}return t}var requestsQueue={},listeners={},requestQueueResolver=function(e){if("string"==typeof e)try{e=JSON.parse(e.normalize())}catch(e){}if(e.id){var t=requestsQueue[e.id];t?("result"in e?t.resolve(e.result):t.reject(e.error),delete requestsQueue[e.id]):console.log("no pending request found with id "+e.id)}},notificationListener=function(t){if("string"==typeof t)try{t=JSON.parse(t.normalize())}catch(e){}if(!t.id&&t.method){var e=listeners[t.method];e&&Array.isArray(e)&&e.length&&e.forEach(function(e){e(t.params)})}},protocol="ws://",host="localhost",endpoint="/jsonrpc",port=80,makeWebsocketAddress=function(e){return[e&&e.protocol||protocol,e&&e.host||host,":"+(e&&e.port||port),e&&e.endpoint||endpoint].join("")},protocols="notification",socket=null,connect=function(n){return new Promise(function(e,t){socket&&1===socket.readyState?e(socket):socket?socket&&0===socket.readyState?socket.addEventListener("open",function(){notificationListener({method:"client.ThunderJS.events.connect"}),e(socket)}):t("Socket closing or closed"):((socket=new WebSocket(makeWebsocketAddress(n),protocols)).addEventListener("message",function(e){requestQueueResolver(e.data)}),socket.addEventListener("message",function(e){notificationListener(e.data)}),socket.addEventListener("error",function(e){notificationListener({method:"client.ThunderJS.events.error"}),socket=null,t(e)}),socket.addEventListener("open",function(){notificationListener({method:"client.ThunderJS.events.connect"}),e(socket)}),socket.addEventListener("close",function(e){socket&&(notificationListener({method:"client.ThunderJS.events.disconnect"}),socket=null,t(e))}))})},makeBody=function(e,t,n,o,r){o&&delete o.version;var i={jsonrpc:"2.0",id:e,method:[t,r,n].join(".")};return!o&&!1!==o||"object"===_typeof(o)&&0===Object.keys(o).length||(i.params=o),i},getVersion=function(e,t,n){var o;return(o=n&&n.version)?o:e&&(e[t]||e.default)||1},id=0,makeId=function(){return id+=1},execRequest=function(t,n){connect(t).then(function(e){e.send(JSON.stringify(n))}).catch(function(e){t.debug&&(console.log(" "),console.log("API ERROR:"),console.log(JSON.stringify(t,null,2)),console.log(" "),console.log("ERROR: "),console.log(JSON.stringify(e,null,2)),console.log(" "))})},API=function(u){return{request:function(i,s,c){return new Promise(function(e,t){var n=makeId(),o=getVersion(u.versions,i,c),r=makeBody(n,i,s,c,o);u.debug&&(console.log(" "),console.log("API REQUEST:"),console.log(JSON.stringify(r,null,2)),console.log(" ")),requestsQueue[n]={body:r,resolve:e,reject:t},execRequest(u,r)})}}},DeviceInfo={freeRam:function(e){return this.call("systeminfo",e).then(function(e){return e.freeram})},version:function(e){return this.call("systeminfo",e).then(function(e){return e.version})}},plugins={DeviceInfo:DeviceInfo};function listener(t,n,e){var o=this,r=register.call(this,t,n,e);return{dispose:function(){var e=makeListenerId(t,n);listeners[e].splice(r,1),0===listeners[e].length&&unregister.call(o,t,n)}}}var api,makeListenerId=function(e,t){return["client",e,"events",t].join(".")},register=function(e,t,n){var o=makeListenerId(e,t);if(!listeners[o]&&(listeners[o]=[],"ThunderJS"!==e)){var r={event:t,id:o.split(".").slice(0,-1).join(".")};this.api.request(e,"register",r)}return listeners[o].push(n),listeners[o].length-1},unregister=function(e,t){var n=makeListenerId(e,t);if(delete listeners[n],"ThunderJS"!==e){var o={event:t,id:n.split(".").slice(0,-1).join(".")};this.api.request(e,"unregister",o)}},thunderJS=function(e){return api=API(e),wrapper(_objectSpread2({},thunder(e),{},plugins))},resolve=function(n,e){"object"===_typeof(n)&&("object"!==_typeof(n)||n.then&&"function"==typeof n.then)||(n=new Promise(function(e,t){(n instanceof Error==!1?e:t)(n)}));var t="function"==typeof e[e.length-1]?e[e.length-1]:null;if(!t)return n;n.then(function(e){return t(null,e)}).catch(function(e){return t(e)})},thunder=function n(e){return{options:e,plugin:!1,call:function(){var e=Array.prototype.slice.call(arguments);this.plugin&&e[0]!==this.plugin&&e.unshift(this.plugin);var t=e[0],n=e[1];return"function"==typeof this[t][n]?this[t][n](e[2]):this.api.request.apply(this,e)},registerPlugin:function(e,t){this[e]=wrapper(Object.assign(Object.create(n),t,{plugin:e}))},subscribe:function(){},on:function(){var e=Array.prototype.slice.call(arguments);return-1!==["connect","disconnect","error"].indexOf(e[0])?e.unshift("ThunderJS"):this.plugin&&e[0]!==this.plugin&&e.unshift(this.plugin),listener.apply(this,e)},once:function(){console.log("todo ...")}}},wrapper=function e(t){return new Proxy(t,{get:function(o,r){var i=o[r];return"api"===r?api:void 0!==i?"function"==typeof i?-1<["on","once","subscribe"].indexOf(r)?function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return i.apply(this,t)}:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return resolve(i.apply(this,t),t)}:"object"===_typeof(i)?e(Object.assign(Object.create(thunder(o.options)),i,{plugin:r})):i:!1===o.plugin?e(Object.assign(Object.create(thunder(o.options)),{},{plugin:r})):function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return t.unshift(r),o.call.apply(this,t)}}})};module.exports=thunderJS;
>>>>>>> Connect: Handle case where socket is still connecting
